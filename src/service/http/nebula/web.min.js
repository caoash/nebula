import{neb}from"./dist/web/main2.js";import{Nebula,count,sum,min,max,avg,tree,p10,p25,p50,p75,p90,p99,p99_9,p99_99,and,or,eq,neq,gt,lt,like,ilike,unlike,iunlike}from"./__/sdk.min.js";import{Constraints}from"../c/constraints.min.js";import{Charts}from"./c/charts2.min.js";let time=neb.time,$$=a=>$(a).val(),ds={keys:[],metrics:[],rows:[],orders:{}},tableInfo={},fpcs,fpce,timeCol="_time_",windowCol="_window_",autoKey=a=>a==timeCol||a==windowCol,charts=new Charts,nebula=new Nebula,chartId="#show",fieldsId="fields",fieldsRef=`#${fieldsId}`,tablesId="#tables",startId="#start",endId="#end",windowId="#window",displayId="#display",NoRollup=-1,msg=a=>$("#qr").text(a),vis=(a,b)=>$(a).css("visibility",b?"visible":"hidden"),FETCH_OPT={method:"GET"},filters,$sdc=null,field=(a,b)=>{let c=b in neb.Rollup;return{M:c?neb.Rollup[b]:NoRollup,C:a,T:c?`${b.toLowerCase()}(${a})`:a}},makeCalendar=(a,b,c,d,e,f)=>{a=$(b).flatpickr({enableTime:!0,allowInput:!0,clickOpens:!1,dateFormat:"Y-m-d H:i:S",defaultDate:d,minDate:e,maxDate:f,allowInvalidPreload:!0}),$(c).on("click",()=>{setTimeout(()=>{a.open()},0)})},onTableState=(a,k,i)=>{tableInfo=a;let l=a.bc,m=Math.round(a.rc/1e4)/100,n=Math.round(a.ms/1e7)/100,b=time.format(1e3*a.mt),c=time.format(1e3*a.xt+1);k.text(`[Blocks: ${l}, Rows: ${m}M, Mem: ${n}GB, Min UTC: ${b}, Max UTC: ${c}]`),makeCalendar(fpcs,startId,"#startc",b,b,c),makeCalendar(fpce,endId,"#endc",c,b,c);let e=(a.dl||[]).filter(a=>a!==timeCol),f=(a.ml||[]).filter(a=>a!==timeCol),j=e.concat(f),g=[];for(let d in j.map(a=>g.push(field(a))),neb.Rollup){if("COUNT"===d){g.push(field(g[0].C,d));continue}let h=f;"TREEMERGE"===d&&(h=e),"CARD_EST"===d&&(h=[...e,...f]),h.map(a=>g.push(field(a,d)))}$("#dwrapper").html(`<select id="${fieldsId}" multiple></select>`);let o=$(fieldsRef).html("");g.forEach(a=>{$("<option/>").appendTo(o).text(a.T).val(`${JSON.stringify(a)}`)}),$sdc=o.selectize({plugins:["restore_on_backspace","remove_button"],persist:!1}),$("#ob").html(""),Object.keys(neb.OrderType).forEach(a=>{$("<option/>").appendTo($("#ob")).text(a.toLowerCase()).val(neb.OrderType[a])}),i&&i(j)},initTable=(a,b)=>{let c=$("#stats");fetch(`/?api=state&start=0&end=0&table=${encodeURIComponent(a)}`,FETCH_OPT).then(a=>a.json()).then(a=>onTableState(a,c,b)).catch(a=>c.text("Error: "+a))},checkRequest=a=>{if(a.metrics&&a.metrics.length>1){for(var b=0;b<a.metrics.length;b++)if(a.metrics[b].M==neb.Rollup.HIST)return msg("Please only select one hist in Fields"),!0}if(!a.start||!a.end)return!0;if(a.timeline){let c=a.window;if(c>0){let e=(a.end-a.start)/1e3,d=e/c;if(d>1e3)return msg(`Too many data points to return ${d}, please increase window granularity.`),!0}if(0==a.metrics.length)return msg("Timeline requires metric fields."),!0}return!1},hash=a=>(a&&(window.location.hash=a),window.location.hash),build=f=>{let a=[],b=[];if($$(fieldsRef).map(d=>{let c=JSON.parse(d);c.M===NoRollup?a.push(c.C):b.push(c)}),0==a.length&&0==b.length&&(a.push(...tableInfo.dl),a.push(...tableInfo.ml),a.sort()),b.length>0&&a.length>2){msg("Risk: too many keys to aggregate by.");return}0==b.length&&a.unshift(timeCol);let e=0,g=["3600","86400","604800","2592000","QUARTERLY","31536000"];for(let c=0;c<6;++c)$$(windowId)===g[c]&&(e=c+1);let d=f||{table:$$(tablesId),start:$$(startId),end:$$(endId),filter:filters.expr(),keys:a,timeline:$("#timeline").is(":checked"),window:$$(windowId),time_unit:e.toString(),metrics:b,sort:$$("#ob"),limit:$$("#limit")};if(console.log(JSON.stringify(d)),!d.start||!d.end){msg("Error: please enter start and end time");return}hash("#"+encodeURIComponent(JSON.stringify(d)))},timer=null,timer2=null,clsTimer=()=>{timer&&clearInterval(timer),timer2&&clearTimeout(timer2)},restore=()=>{clsTimer();let b=url2state(),c=(b,a)=>{a&&$(b).val(a)},a=b.table,d=!1,e=null;$(`${tablesId} option`).each((c,b)=>{e=e||b.value,b.value===a&&(d=!0)}),d||(timer=animate(`preparing table ${a} `),timer2=setTimeout(()=>{location.reload()},3e3),a=e),a&&(c(tablesId,a),initTable(a,f=>{c(startId,b.start),c(endId,b.end),$("#timeline").prop("checked",b.timeline),c(windowId,b.window),vis(windowId,b.timeline),c("#ob",b.sort),c("#limit",b.limit);let a=[];(b.keys||[]).map(b=>a.push(JSON.stringify(field(b)))),(b.metrics||[]).map(b=>a.push(JSON.stringify(b))),$sdc&&a.length>0&&$sdc[0].selectize.setValue(a);let g={EQ:"=",NEQ:"!=",MORE:">",LESS:"<",LIKE:"like",ILIKE:"ilike",UNLIKE:"unlike",IUNLIKE:"iunlike"},d={};for(var e in neb.Operation)d[neb.Operation[e]]=g[e];filters=new Constraints(!1,"filters",f,d,b.filter),b.code&&b.code.length>0&&editor.getValue()!=b.code&&(editor.setValue(b.code),ide()),execute(b)}))},onQueryResult=(state,r)=>{if(r.error){msg(`[query: error=${r.error}, latency=${r.duration} ms]`);return}for(let key in msg(`[query: latency=${r.duration}ms, scan=${r.rows_scan}, blocks=${r.blocks_scan}, rows=${r.rows_ret}]`),ds.timeline=state.timeline,ds.rows=JSON.parse(atob(r.data)),ds.keys=[...state.keys],ds.metrics=[],ds.rows[0])ds.keys.includes(key)||autoKey(key)||ds.metrics.push(key);if(state.pivot){let pvc=state.pivot,mc=ds.metrics[0],dataMap={},keys=ds.keys.filter(a=>a!=pvc);state.timeline&&keys.push(windowCol);let metrics={},mapKey=c=>{let e=[],a={};keys.forEach(b=>{let d=c[b];a[b]=d,e.push(`${d}`)});let b=e.join("-");b in dataMap?a=dataMap[b]:dataMap[b]=a;let d=c[pvc];metrics[d]=1,a[d]=c[mc]};ds.rows.forEach(mapKey);let rows=[];for(let k in dataMap){let r=dataMap[k];for(let m in metrics)m in r||(r[m]=0);rows.push(r)}ds.rows=rows,ds.keys=keys.filter(a=>a!=windowCol),ds.metrics=Object.keys(metrics)}if(state.map&&state.map.length>0){let nmap=eval(state.map)();if(nmap&&"function"==typeof nmap)for(let col in ds.rows.forEach(nmap),ds.rows[0])autoKey(col)||ds.keys.includes(col)||ds.metrics.includes(col)||ds.metrics.push(col)}if(state.rm&&state.rm.length>0){let reduced=ds.metrics.filter(a=>!state.rm.includes(a));reduced.length<ds.metrics.length&&(ds.metrics=reduced)}if($("#table").html(""),$(displayId).hide(),0==ds.rows.length){$("#show").html("<b>NO RESULTS.</b>");return}let choices=b=>{let a=b||[];a.length>0?$(displayId).show():$(displayId).hide(),$(displayId).html(""),a.forEach(a=>$("<option/>").appendTo($(displayId)).text(a).val(a))};ds.timeline?choices(["timeline","timeline-area","timeline-bar"]):1==state.metrics.length&&state.metrics[0].M==neb.Rollup.TREEMERGE?choices(["icicle","flame"]):1==state.metrics.length&&state.metrics[0].M==neb.Rollup.HIST?choices(["column","bar","none"]):state.metrics.length>0?choices(["column","bar","doughnut","pie","line","none"]):choices();let draw=()=>{$(chartId).html("");let a=[...ds.keys],c=[...ds.rows],b=[...ds.metrics];if(a.length>1){let i=" - ",j=a.join(i);c.forEach(b=>{b[j]=a.map(a=>b[a]).join(i)}),a.length=0,a.push(j)}let e=histJsonIdx(b),d=null,f=!0;if(-1!=e){f=!1;let[k,l]=processHistJson(c,b,e);c.length=0,k.map(a=>c.push(a)),b.length=0,l.map(a=>b.push(a))}let h=$(displayId).val(),g=1e3*time.seconds(state.start);switch(h){case"timeline":d=charts.displayTimeline(chartId,c,a,b,windowCol,g,0);break;case"timeline-area":d=charts.displayTimeline(chartId,c,a,b,windowCol,g,1);break;case"timeline-bar":d=charts.displayTimeline(chartId,c,a,b,windowCol,g,2);break;case"icicle":d=charts.displayFlame(chartId,c,a,b,!1),f=!1;break;case"flame":d=charts.displayFlame(chartId,c,a,b,!0),f=!1;break;case"column":d=charts.displayBar(chartId,c,a,b,!0,-1!=e);break;case"bar":d=charts.displayBar(chartId,c,a,b,!1,-1!=e);break;case"doughnut":d=charts.displayPie(chartId,c,a,b,!0);break;case"pie":d=charts.displayPie(chartId,c,a,b,!1);break;case"line":d=charts.displayLine(chartId,c,a,b)}f&&($("#table").attr("class","fh300"),charts.displayTable("#table",ds.rows,[timeCol,windowCol,...ds.keys],ds.metrics),(0==b.length||"none"===h)&&$("#table").removeClass("fh300")),d&&msg(`Error: ${d}`)};draw();var resizeTimer=void 0;$(window).on("resize",()=>{clearTimeout(resizeTimer),resizeTimer=setTimeout(draw,200)}),$(displayId).change(draw),window.n_sort=b=>{if(ds.timeline)return;let a="ASC",d="DESC",c=(ds.orders[b]||a)===a?d:a;ds.orders[b]=c;let e=c===a?(a,b)=>a>b?1:-1:(a,b)=>a<b?1:-1;ds.metrics.includes(b)?ds.rows.sort((a,c)=>e(+a[b],+c[b])):ds.rows.sort((a,c)=>e(a[b],c[b])),draw()}},histJsonIdx=b=>{for(var a=0;a<b.length;a++)if(b[a].endsWith(".HIST"))return a;return -1},processHistJson=(e,m,n)=>{let g=[],h=[];for(var d=0;d<e.length;d++){let f={},i={};for(var c in e[d])if(c===m[n]){let b=JSON.parse(e[d][c]).b,j={},k=[];for(var a=0;a<b.length;a++){let o=b[a][2],l;j[l=0===a?"[min, "+b[a][1]+"]":a===b.length-1?"["+b[a][0]+", max]":"["+b[a][0]+", "+b[a][1]+"]"]=o,k.push(l)}f[c]=j,i[c]=k}else f[c]=e[d][c];h.push(i),g.push(f)}return[g,h]},url2state=()=>{let a=decodeURIComponent((hash()||`#${$$(tablesId)}`).substr(1)),b={table:a};try{b=JSON.parse(a)}catch{}return b},dots=0,animate=(b,a)=>setInterval(()=>{msg(`${b}${".".repeat(dots=(dots+1)%50)}`)},a||200),execute=a=>{if(a||(a=url2state()),checkRequest(a))return;timer=animate("soaring in nebula ");let b=`/?api=query&start=0&end=0&query=${encodeURIComponent(JSON.stringify(a))}`;fetch(b,FETCH_OPT).then(a=>a.json()).then(b=>{clsTimer(),onQueryResult(a,b)}).catch(a=>{clsTimer(),msg(`Error: ${a}`)})};$("#share").on("click",()=>{let a=location.href.substr(location.origin.length);fetch("/?api=url",{method:"POST",headers:{"content-type":"application/json"},body:a}).then(a=>a.json()).then(a=>{a.code&&a.code.length>4&&msg(`[query url: ${location.origin}/n/${a.code}]`)}).catch(a=>{msg(`Error: ${a}`)})});let editor=CodeMirror.fromTextArea($("#code").get(0),{lineNumbers:!1,lineWrapping:!0,styleActiveLine:!0,matchBrackets:!0,mode:"javascript",theme:"dracula"}),ide=()=>{let a="tap-on",b="tap-off",c=$(`.${a}`),d=$(`.${b}`);c.removeClass(a).addClass(b),d.removeClass(b).addClass(a),setTimeout(()=>editor.refresh(),5)},iside=()=>"tap-off"==$("#qc").attr("class"),exec=()=>{let code=editor.getValue();nebula.reset();try{eval(code)}catch(e){msg(`Code Error: ${e.message}`);return}let error=nebula.validate();if(error){msg(`Validation Error: ${error}`);return}let state=nebula.build();state.code=code,build(state)};window.onhashchange=function(){restore()};let onTableList=a=>{if(a&&a.length>0){a.sort().forEach(a=>$("<option/>").appendTo($(tablesId)).text(a).val(a)),restore();return}msg("Nebula is down: can not fetch tables")};$(()=>{let a=$("#stats");fetch("/?api=tables&start=0&end=0",FETCH_OPT).then(a=>a.json()).then(a=>{onTableList(a)}).catch(b=>{a.text("Error: "+b)}),$(tablesId).change(()=>{hash($(tablesId).val()),restore()}),fetch("/?api=user",FETCH_OPT).then(a=>a.json()).then(a=>{$("#user").text(a.auth?a.user:"unauth")})}),$("#exec").click(a=>{iside()?exec():build()}),$("#ui").on("click",ide),$("#timeline").click(function(){vis(windowId,$(this).is(":checked"))})