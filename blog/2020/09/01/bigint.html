<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Nebula Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Nebula Blog Atom Feed"><title data-react-helmet="true">BigInt Problem | Nebula</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://varchar-io.github.io/blog/2020/09/01/bigint"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="BigInt Problem | Nebula"><meta data-react-helmet="true" name="description" content="We know that Javascript can only represent 2^53-1 as it max number. For any values larger than that will lose precision during data exchange in javascript runtime. Most of the time, we have to pay cost to serializing 64bits in string format."><meta data-react-helmet="true" property="og:description" content="We know that Javascript can only represent 2^53-1 as it max number. For any values larger than that will lose precision during data exchange in javascript runtime. Most of the time, we have to pay cost to serializing 64bits in string format."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-09-01T00:00:00.000Z"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://varchar-io.github.io/blog/2020/09/01/bigint"><link data-react-helmet="true" rel="alternate" href="https://varchar-io.github.io/blog/2020/09/01/bigint" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://varchar-io.github.io/blog/2020/09/01/bigint" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ca62a3d1.css">
<link rel="preload" href="/assets/js/runtime~main.3e300a69.js" as="script">
<link rel="preload" href="/assets/js/main.583cd0b0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/nebula.svg" alt="Nebula Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/nebula.svg" alt="Nebula Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Nebula Docs</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/varchar-io/nebula" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/04/01/custom_column">Custom Column - Instant UDF</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/03/01/expression_udf_udaf">Expression, UDF, and UDAF</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/02/01/sketch">Sketch: extensible customized aggregation</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/01/01/web_ui">Web UI</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2020/09/01/bigint">BigInt Problem</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">BigInt Problem</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2020-09-01T00:00:00.000Z" itemprop="datePublished">September 1, 2020</time> Â· 3 min read</div></header><div class="markdown" itemprop="articleBody"><p>We know that Javascript can only represent 2^53-1 as it max number. For any values larger than that will lose precision during data exchange in javascript runtime. Most of the time, we have to pay cost to serializing 64bits in string format.</p><p>Nebula faces this issue too, in this short note, I would just like to summarize all places with the concern and how we handle them for now, this doesn&#x27;t mean it is ideal, in fact, we are still looking for improvements. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="no-1-rapidjson"></a>No 1. rapidjson<a class="hash-link" href="#no-1-rapidjson" title="Direct link to heading">#</a></h2><p>We have been using RapidJson as the JSON serde library in our C++ runtime, due to its capability handling this concern well.
We don&#x27;t do <code>long&lt;--&gt;string</code> conversion trick. Hence we removed similar trick in your code base, specifically in InExpression serde code path.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="no-2-nodejs"></a>No 2. node.js<a class="hash-link" href="#no-2-nodejs" title="Direct link to heading">#</a></h2><p>node.js is the web server runtime <code>Nebula Web</code> resides in, it is definitely the most hot place regarding this issue. We have been using JSON as data fromat to exchange requests/responses between <code>web client</code> and <code>Nebula Server</code>.  Here are what we have done:</p><ol><li>We&#x27;re using json-bigint package to do <code>json.parse</code> so if the input JSON includes bigint values, it won&#x27;t lose the value&#x27;re precision.</li><li>In nebula proto, we added two more types of predicate, so it allows client to use one of them<ol><li>value: string type </li><li>nvalue: int64 type</li><li>dvalue: double type.</li></ol></li></ol><p>with this change, we don&#x27;t pay string-&gt;int or string-&gt;double type data conversion. (In fact, protobuf does this for us - it is uncertain if perf is better, but at least cleaner at interface).</p><p>The serde work is dene by protobuf-js, which is still using <code>Number</code> for all number values, so the problem still exists, if passing bigint value in <code>grpc</code> call defined by int64 in <code>nebula.proto</code>, Nebula Server may receive wrong value. And I haven&#x27;t seen this is going to be fixed soon anywhere. We will keep eyes open for any alternative solution.</p><p>As a work-around, we will use &quot;string&quot; representation for <code>nvalue</code> by appending <code>[jstype = JS_STRING]</code> in its proto declaration. After that, we requires client to send string list for this field for now. Definitely this is neither convinient nor efficient.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="no-3-web"></a>No 3. web<a class="hash-link" href="#no-3-web" title="Direct link to heading">#</a></h2><p>In <code>Nebula UI</code> which means browser here, we haven&#x27;t handle any thing like this, since it is for display purpose, basically all bigint values are returned in <code>string</code> type. Client code (browser js) needs to convert it if used in further computation.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="no-4-other-clients"></a>No 4. other clients.<a class="hash-link" href="#no-4-other-clients" title="Direct link to heading">#</a></h2><p>This is obvious but just to mention, other clients that is not executing in javascript runtime should not have this issue, for example, if I use <code>curl</code> to post a JSON blob of bigint array, <code>Nebula API</code> (node.js) won&#x27;t lose precision of values. Other clients like Java should be fine too.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/01/01/web_ui"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Web UI</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#no-1-rapidjson" class="table-of-contents__link">No 1. rapidjson</a></li><li><a href="#no-2-nodejs" class="table-of-contents__link">No 2. node.js</a></li><li><a href="#no-3-web" class="table-of-contents__link">No 3. web</a></li><li><a href="#no-4-other-clients" class="table-of-contents__link">No 4. other clients.</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/nmZsXC53" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/varchario" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/varchar-io/nebula" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Columns AI, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3e300a69.js"></script>
<script src="/assets/js/main.583cd0b0.js"></script>
</body>
</html>