<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Nebula Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Nebula Blog Atom Feed"><title data-react-helmet="true">Expression, UDF, and UDAF | Nebula</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://varchar-io.github.io/blog/2021/03/01/expression_udf_udaf"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Expression, UDF, and UDAF | Nebula"><meta data-react-helmet="true" name="description" content="Nebula analytics relies on aggregations, and these aggregations are expressed by"><meta data-react-helmet="true" property="og:description" content="Nebula analytics relies on aggregations, and these aggregations are expressed by"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-03-01T00:00:00.000Z"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://varchar-io.github.io/blog/2021/03/01/expression_udf_udaf"><link data-react-helmet="true" rel="alternate" href="https://varchar-io.github.io/blog/2021/03/01/expression_udf_udaf" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://varchar-io.github.io/blog/2021/03/01/expression_udf_udaf" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ca62a3d1.css">
<link rel="preload" href="/assets/js/runtime~main.3e300a69.js" as="script">
<link rel="preload" href="/assets/js/main.583cd0b0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/nebula.svg" alt="Nebula Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/nebula.svg" alt="Nebula Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Nebula Docs</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/varchar-io/nebula" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/04/01/custom_column">Custom Column - Instant UDF</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2021/03/01/expression_udf_udaf">Expression, UDF, and UDAF</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/02/01/sketch">Sketch: extensible customized aggregation</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/01/01/web_ui">Web UI</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/09/01/bigint">BigInt Problem</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Expression, UDF, and UDAF</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-03-01T00:00:00.000Z" itemprop="datePublished">March 1, 2021</time> Â· 3 min read</div></header><div class="markdown" itemprop="articleBody"><p><strong>Nebula</strong> analytics relies on aggregations, and these aggregations are expressed by</p><ul><li>Expressions: including constant ops, arthmetic ops, logical ops and column ops.
These operations are basics for a programing language, hence they are fundementals to nebula query engine.   </li><li>UDF: nebula will provide native UDFs in its own package implemented with native code.
We plan to add customized UDF through user interface which will be available in javascript. V8 engine will be used to execute them with interopability with Nebula runtime data strucutre.
Basic built-in UDFs are &quot;in&quot;, &quot;not in&quot;, &quot;like&quot;, &quot;ilike&quot;, etc.</li><li>UDAF: core analytic capability are supported by &quot;aggregation metrics by dimensions&quot;.
Nebula provides efficient implementations for them, UDAF like &quot;count&quot;, &quot;sum&quot;, &quot;avg&quot;, &quot;median&quot;, &quot;percentiles&quot;, &quot;NDV&quot; shall be available.</li></ul><p>Plug-in a new UDF / UDAF should be straigtforward in nebula code base, feel free to submit a new request through issue or PR. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="avg"></a>AVG<a class="hash-link" href="#avg" title="Direct link to heading">#</a></h2><p>UDAF &quot;avg&quot; is an interesting topic, I have been thinking a lot on how to implement it.
Basically there are two major approaches (well essentially the same concept)
1) Having SUM / COUNT columns in computing time and convert to AVG column at the last step.
In this approach, we flex the schema and operate in query level.
2) Have &quot;special&quot; column type such as a binary buffer or wider type like int128.
It is similar to number 1 in terms of flexing schema, but it doesn&#x27;t change column count.</p><p>I think #1 provides pretty generic solution for many similar problem - extend data store in runtime by adding more columns. #2 sounds a bit hacky, but because it maintains same width of schema, a lot of checks and type converts becoming naturely easy. So in the first try, I chose to implement AVG using #2 approach without changing much on the query planning itself.</p><p>A very important data structure used in Nebula is called &quot;HashFlat&quot;, it&#x27;s basically a row-based data set with hash function to keep unique rows in contingious memory block. It needs client to provide interfaces to process data in different type:</p><ul><li>Store:    convert UDAF inner expression value into the store type in hash flat.</li><li>Merge:    merge two rows with same keys.</li><li>Finalize: convert store type into desired type.</li></ul><p>A UDAF will define these 3 functions, and when a hash flat is setup, a wrapper of this function set will be provided.
So when HashFlat receives a duplicate rows (same keys), it will trigger the merge function, and new row to trigger store method, for most cases, since store type equals native type, it will have empty store and finalize method.
<img alt="UDF + Types" src="/assets/images/udf.types-60d1101e2b3972371056caf7d65642d2.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="percentiles-ndv-and-others"></a>Percentiles, NDV and others<a class="hash-link" href="#percentiles-ndv-and-others" title="Direct link to heading">#</a></h2><p>Follow the same pattern, for any UDAF that requires state management, it can go the same design as AVG using a store type for state management and use finalize method to convert temporary state to final value.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/04/01/custom_column"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Custom Column - Instant UDF</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/02/01/sketch"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Sketch: extensible customized aggregation Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#avg" class="table-of-contents__link">AVG</a></li><li><a href="#percentiles-ndv-and-others" class="table-of-contents__link">Percentiles, NDV and others</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/nmZsXC53" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/varchario" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/varchar-io/nebula" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Columns AI, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3e300a69.js"></script>
<script src="/assets/js/main.583cd0b0.js"></script>
</body>
</html>