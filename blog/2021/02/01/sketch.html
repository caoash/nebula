<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Nebula Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Nebula Blog Atom Feed"><title data-react-helmet="true">Sketch: extensible customized aggregation | Nebula</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://varchar-io.github.io/blog/2021/02/01/sketch"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Sketch: extensible customized aggregation | Nebula"><meta data-react-helmet="true" name="description" content="We need extensible model to support adding any customized data structure for special data aggregation."><meta data-react-helmet="true" property="og:description" content="We need extensible model to support adding any customized data structure for special data aggregation."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-02-01T00:00:00.000Z"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://varchar-io.github.io/blog/2021/02/01/sketch"><link data-react-helmet="true" rel="alternate" href="https://varchar-io.github.io/blog/2021/02/01/sketch" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://varchar-io.github.io/blog/2021/02/01/sketch" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ca62a3d1.css">
<link rel="preload" href="/assets/js/runtime~main.24edf28c.js" as="script">
<link rel="preload" href="/assets/js/main.583cd0b0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/nebula.svg" alt="Nebula Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/nebula.svg" alt="Nebula Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Nebula Docs</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/varchar-io/nebula" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/04/01/custom_column">Custom Column - Instant UDF</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/03/01/expression_udf_udaf">Expression, UDF, and UDAF</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2021/02/01/sketch">Sketch: extensible customized aggregation</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/01/01/web_ui">Web UI</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/09/01/bigint">BigInt Problem</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Sketch: extensible customized aggregation</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-02-01T00:00:00.000Z" itemprop="datePublished">February 1, 2021</time> Â· 5 min read</div></header><div class="markdown" itemprop="articleBody"><p>We need extensible model to support adding any customized data structure for special data aggregation.
It is challenge to make a decent design fitting into this requirements, let&#x27;s take a look at what current system</p><ul><li>UDAF/UDF are modeled as generic expressions which represented by ValueEval or TypeValueEval in the runtime.<ul><li>ValueEval is extensible as long as it is visible, it has methods &quot;eval&quot; for value evaluation, &quot;merge&quot; for value merging, &quot;stack&quot; for value accumulation between different types.</li><li>UDAF needs differentiate input type, runtime type and schema type so that it can finish aggregation life cycle.</li></ul></li><li>RowData interface is the generic interface used to exchange data between any compute layers.<ul><li>Expressions details are hidden by RowData interface which supports only readXXX methods for each individual supported types in our schema system.</li></ul></li><li>Sometimes it is not performant if we don&#x27;t expose &quot;input type&quot; to compute layer when customized type is involved. </li></ul><p>For example, if we&#x27;re building a TDigest sketch for given expression typed in integer, assuming we have TDigestUDAF which defined types</p><ul><li>input type: INTEGER</li><li>runtime type: TDigest Object modeled as &quot;void*&quot; or better std::shared_ptr&lt;Serializable&gt;</li><li>schema type: VARCHAR</li></ul><p>In computing time, when we iterate all rows, remember that the UDAF expression is hidden beind by a RowData interface which only allow a given column which contains the UDAF to expose one type, usually we expose runtime type, that means we only have RowData.readPointer(), the implication here is that we might end up with constructing/descruting huge number of TDigest objects, this doesn&#x27;t sound correct and definitely not scalable for &quot;customized&quot; sketch.</p><p><img alt="Where to put aggregation" src="/assets/images/sketch-364f2f00c3a6aefded1086b32559009d.png"></p><p>(External Compute: HB)</p><p>To overcome this hurdle, we have a few options to consider</p><ol><li>Expose UDAF as its inner expression, and leave its aggregation logic to external compute.<ol><li>e.g SUM(EXPR1) -&gt; EXPR1 through RowData interface</li><li>Sure, external compute will have enough metadata to understand how to invoke its logic for aggregation.</li><li>Pros &amp; Cons: very straightforward and leave data layer clean. The downside is the inconsistency in the schema, since most of the time, the UDAF result value type differs from its inner expression type.</li></ol></li><li>Expose different interface in RowData to allow external compute to fetch inner experssion value instead.<ol><li>This approach doesn&#x27;t change its current runtime schema.</li><li>Some kind of brokeness on RowData interface.</li><li>Difficult to manage life cycle of the custom object since UDAF itself creates object internally and pass to external compute to manage.</li></ol></li></ol><p>None of above approaches is ideal and it is difficult to sort out an ideal approach for now.
Here is what I propose to do to make this a bit cleaner hopefully:</p><ol><li>Mainly take approach 1 to keep UDAF interface clean and simple.</li><li>Push complexity into HB by introducing aggregator object for each defined UDAF.</li><li>The aggregator may or may not require extra object allocation, depends on if it needs assistant data structure.<ol><li>CreateObject</li><li>Aggregate</li><li>Serde</li></ol></li><li>We need to allow all UDAF to have different runtime schema but with final schema corrected in last stage.</li></ol><p>Hopefully this change will help boost performance as well, for example AVG. Since this is going to be large refactoring, I will leave it to next diff and report back what the result looks like - the basic measure is ensure AVG UDAF is working well/better in the new design.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="update"></a>Update<a class="hash-link" href="#update" title="Direct link to heading">#</a></h3><p>Through the whole Nebula code base, all the boundary is communicated through RowData and its cursor type RowCursor, it is extremely difficult to model a customized object (aggregator) on a plain storage wrapped by a RowData, and also to be very efficient to avoid object allocations across rows. I also looked at &quot;struct&quot; type, if we can reuse it to represent any customized sketch but attached with different functions, again it is good idea to keep RowData interface intact but facing two big challenges:</p><ol><li>construct sketch object on given memory chunk represented by the struct. (preventing object serde per row)</li><li>avoid object creation for non-aggregated rows. </li></ol><p>Given all the thoughts and exploration, I decided to make the change to RowData interface, adding a new interface to it to fetch aggregator object given column name/index.
Client will get a valid aggregator object if </p><ul><li>the row represents an aggregated row</li><li>the column is an aggregation column</li></ul><p>otherwise it will return a nullptr.</p><p>Aggregation column type will be the same as its inner expression type, so that we know if a ROW can return normal value to be aggregated or it can return aggregator to aggregate other incoming values in block computing phase.</p><p>In merge phase - aggregator will aggregate other aggregators.</p><p>In final phase - an aggregator will provide finalize method to return its desired value.</p><p>In the new architecture, any sketch is attached and can be detached. As optimization, it may share memory as schema indicates which is controlled by column width. If the column is an aggregation field, it will produce alignment space for the column no matter it has null value or not.</p><p>When serialization, sketch will be serialized into data space, and deserialization will be restruct the sketch for each aggregation column.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/03/01/expression_udf_udaf"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Expression, UDF, and UDAF</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/01/01/web_ui"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Web UI Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#update" class="table-of-contents__link">Update</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/nmZsXC53" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/varchario" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/varchar-io/nebula" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Columns AI, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.24edf28c.js"></script>
<script src="/assets/js/main.583cd0b0.js"></script>
</body>
</html>